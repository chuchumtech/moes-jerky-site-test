<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Moe's Jerky Admin</title>
  <style>
    /* Theme Variables */
    :root {
      --primary-color: #8B0000;
      --secondary-color: #333333;
      --bg-color: #F9F9F9;
      --text-color: #333333;
      --muted-color: #777777;
      --border-radius: 8px;
      --transition-time: 0.3s;
    }
    /* Reset & Base */
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; color: var(--text-color); background: var(--bg-color); display: flex; height: 100vh; }
    /* Login Screen */
    #login { display: flex; flex-direction: column; align-items: center; justify-content: center; width: 100vw; }
    #login h2 { margin-bottom: 1rem; color: var(--primary-color); }
    .code-box { width: 50px; height: 50px; font-size: 24px; text-align: center; margin: 0 8px; border: 2px solid var(--muted-color); border-radius: var(--border-radius); transition: border-color var(--transition-time); }
    .code-box:focus { outline: none; border-color: var(--primary-color); }
    #login-error { color: red; margin-top: 1rem; }
    /* Admin Layout */
    #admin { display: none; width: 100%; height: 100vh; }
    /* Sidebar */
    .sidebar { position: fixed; top: 0; left: 0; width: 200px; height: 100%; background: var(--secondary-color); color: #fff; padding: 1.5rem 1rem; display: flex; flex-direction: column; transition: width var(--transition-time); }
    .sidebar.collapsed { width: 60px; }
    .sidebar .toggle-btn { align-self: flex-end; background: none; border: none; color: #fff; font-size: 24px; cursor: pointer; margin-bottom: 2rem; }
    .sidebar .tab-btn { width: 100%; background: none; border: none; color: #fff; text-align: left; padding: 0.75rem 1rem; margin-bottom: 0.5rem; border-radius: var(--border-radius); cursor: pointer; transition: background var(--transition-time); }
    .sidebar .tab-btn.active, .sidebar .tab-btn:hover { background: var(--primary-color); }
    .sidebar #loggedInUser { margin-bottom: 2rem; font-size: 0.9rem; font-style: italic; }
    /* Content */
    .content { margin-left: 200px; padding: 2rem; height: 100%; overflow-y: auto; transition: margin-left var(--transition-time); width: calc(100% - 200px); }
    .sidebar.collapsed + .content { margin-left: 60px; width: calc(100% - 60px); }
    /* Tabs */
    .tab-content { display: none; background: #fff; padding: 1.5rem; border-radius: var(--border-radius); box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    .tab-content.active { display: block; }
    .tab-content h2 { margin-bottom: 1rem; color: var(--primary-color); }
    /* Tables */
    table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
    th, td { border: 1px solid #e0e0e0; padding: 0.75rem; text-align: left; }
    th { background: var(--bg-color); font-weight: 600; }
    tr:nth-child(even) { background: #fcfcfc; }
    /* Inputs & Buttons */
    input[type="text"], input[type="number"], select { padding: 0.5rem; border: 1px solid #ccc; border-radius: var(--border-radius); width: 100%; }
    .add-btn, .save-btn, .export-btn { margin-top: 1rem; padding: 0.75rem 1.5rem; background: var(--primary-color); color: #fff; border: none; border-radius: var(--border-radius); cursor: pointer; transition: background var(--transition-time); }
    .add-btn:hover, .save-btn:hover, .export-btn:hover { background: #6e0000; }
  </style>
</head>
<body>
  <!-- Login Screen -->
  <div id="login">
    <h2>Welcome to Moe's Jerky Admin</h2>
    <div style="display:flex; margin-bottom:1rem;">
      <input maxlength="1" class="code-box" />
      <input maxlength="1" class="code-box" />
      <input maxlength="1" class="code-box" />
      <input maxlength="1" class="code-box" />
      <input maxlength="1" class="code-box" />
      <input maxlength="1" class="code-box" />
    </div>
    <div id="login-error"></div>
  </div>

  <!-- Admin Interface -->
  <div id="admin">
    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
      <button class="toggle-btn" onclick="toggleSidebar()">â˜°</button>
      <div id="loggedInUser"></div>
      <button class="tab-btn active" data-tab="orders" onclick="switchTab('orders')">Orders</button>
      <button class="tab-btn" data-tab="products" onclick="switchTab('products')">Products</button>
      <button class="tab-btn" data-tab="users" onclick="switchTab('users')">Users</button>
      <button class="tab-btn" data-tab="analytics" onclick="switchTab('analytics')">Analytics</button>
    </div>
    <!-- Content Area -->
    <div class="content">
      <!-- Orders -->
      <div id="ordersTab" class="tab-content active">
        <h2>Orders Management</h2>
        <input id="orderSearch" type="text" placeholder="Search orders..." oninput="renderOrders()" />
        <button class="export-btn" onclick="exportOrders()">Export CSV</button>
        <table id="ordersTable">
          <tr><th>Customer</th><th>Items</th><th>Total</th><th>Status</th><th>Actions</th></tr>
        </table>
      </div>
      <!-- Products -->
      <div id="productsTab" class="tab-content">
        <h2>Product Management</h2>
        <table id="productsTable">
          <tr><th>Name</th><th>Price</th><th>Actions</th></tr>
        </table>
        <button class="add-btn" onclick="addProduct()">+ Add New Item</button>
        <button class="save-btn" onclick="saveProducts()">Save Changes</button>
      </div>
      <!-- Users -->
      <div id="usersTab" class="tab-content">
        <h2>User Management</h2>
        <table id="usersTable">
          <tr><th>Name</th><th>Code</th><th>Actions</th></tr>
        </table>
        <div id="addUserForm" style="display:none; margin-top:1rem;">
          <input id="newUserName" class="user-input" type="text" placeholder="Name" style="margin-bottom:0.5rem;" />
          <input id="newUserCode" class="user-input" type="text" placeholder="6-digit Code" style="margin-bottom:0.5rem;" />
          <button class="save-btn" onclick="addUser()">Save User</button>
        </div>
        <button class="add-btn" id="showAddUserBtn" onclick="showAddUserForm()">Add User</button>
        <button class="save-btn" onclick="saveUsers()">Save All Users</button>
      </div>
      <!-- Analytics -->
      <div id="analyticsTab" class="tab-content">
        <h2>Analytics Dashboard</h2>
        <div id="stats">
          <p>Total Sales: <strong id="totalSales">$0.00</strong></p>
          <p>Number of Orders: <strong id="orderCount">0</strong></p>
          <p>Avg Order Value: <strong id="avgOrder">$0.00</strong></p>
        </div>
        <h3>Top Products</h3>
        <ul id="topProducts"></ul>
        <h3>Customer Spending</h3>
        <ul id="customerStats"></ul>
      </div>
    </div>
  </div>

  <script>
    let users = [], items = [], orders = [], currentUser = null;
    window.onload = function() {
      // Check localStorage for login
      const loginData = JSON.parse(localStorage.getItem('moes_admin_login') || 'null');
      if (loginData && loginData.expires > Date.now()) {
        currentUser = loginData.user;
        showAdmin();
        return;
      } else {
        // If expired, clear it
        localStorage.removeItem('moes_admin_login');
      }
      // Login setup
      const boxes = document.querySelectorAll('.code-box');
      boxes[0].focus();
      boxes.forEach((b, i) => {
        b.addEventListener('input', () => {
          if (b.value && i < boxes.length - 1) boxes[i + 1].focus();
          if ([...boxes].every(x => x.value)) checkCode();
        });
        b.addEventListener('keydown', e => {
          if (e.key === 'Backspace' && !b.value && i > 0) boxes[i - 1].focus();
        });
      });
    };
    async function checkCode() {
      const code = [...document.querySelectorAll('.code-box')].map(x => x.value).join('');
      // Super Admin bypass
      if (code === '258022') { currentUser = { name: 'Super Admin' }; showAdmin(); return; }
      // Dynamic validation
      const res = await fetch('https://moes-jerky-backend3.onrender.com/users');
      users = await res.json();
      const u = users.find(x => x.code === code);
      if (u) { currentUser = u; showAdmin(); } else {
        document.getElementById('login-error').innerText = 'Invalid code';
      }
    }
    function showAdmin() {
      document.getElementById('login').style.display = 'none';
      document.getElementById('admin').style.display = 'flex';
      document.getElementById('loggedInUser').innerText = `Logged in as: ${currentUser.name}`;
      // Save login state with 5 min expiry
      localStorage.setItem('moes_admin_login', JSON.stringify({ user: currentUser, expires: Date.now() + 5 * 60 * 1000 }));
      switchTab('orders');
    }
    function toggleSidebar() {
      document.getElementById('sidebar').classList.toggle('collapsed');
    }
    function switchTab(tab) {
      document.querySelectorAll('.tab-content').forEach(e => e.classList.remove('active'));
      document.getElementById(tab + 'Tab').classList.add('active');
      document.querySelectorAll('.sidebar .tab-btn').forEach(b => b.classList.remove('active'));
      document.querySelector(`.sidebar .tab-btn[data-tab="${tab}"]`).classList.add('active');
      if (tab === 'orders') renderOrders();
      if (tab === 'products') renderProducts();
      if (tab === 'users') renderUsers();
      if (tab === 'analytics') renderAnalytics();
    }
    // Orders
    async function renderOrders() {
      const res = await fetch('https://moes-jerky-backend3.onrender.com/orders'); orders = await res.json();
      const table = document.getElementById('ordersTable'), s = document.getElementById('orderSearch').value.toLowerCase();
      table.innerHTML = '<tr><th>Order #</th><th>Customer</th><th>Items</th><th>Total</th><th>Type</th><th>Status</th><th>Actions</th></tr>';
      orders.filter(o => { const c = o.customer || {}; return c.name.toLowerCase().includes(s) || c.email.toLowerCase().includes(s) || c.phone.includes(s); }).forEach(o => {
        console.log('Order object:', o);
        table.innerHTML += `<tr>
          <td>${o.orderNumber || '-'}</td>
          <td><a href="order.html?id=${o._id}" target="_blank" style="color:#8B0000; text-decoration:underline; font-weight:600;">${o.customer.name}</a></td>
          <td>${o.cart.map(i => i.name + ' x' + i.quantity).join(', ')}</td>
          <td>$${o.amount.toFixed(2)}</td>
          <td>${o.customer.fulfillment === 'delivery' ? 'Delivery' : 'Pickup'}</td>
          <td>
  <select id="status-select-${o._id}" onchange="showSaveButton('${o._id}')">
    <option ${o.status==='Processing'?'selected':''}>Processing</option>
    <option ${o.status==='Shipped'?'selected':''}>Shipped</option>
    <option ${o.status==='Delivered'?'selected':''}>Delivered</option>
  </select>
  <button id="save-status-${o._id}" class="save-btn" style="display:none; margin-left:8px; padding:0.45rem 1.1rem; font-size:0.95em;" onclick="saveOrderStatus('${o._id}')">Save</button>
</td>
          <td><button onclick="deleteOrder('${o._id}')">Delete</button></td>
        </tr>`;
      });
    }
    async function updateOrderStatus(id, status) {
  console.log('Updating order status:', id, status);
  await fetch(`https://moes-jerky-backend3.onrender.com/orders/${id}`, {
    method: 'PUT',
    headers: { 'Content-Type':'application/json' },
    body: JSON.stringify({status})
  });
  renderOrders();
}
    async function deleteOrder(id) { if (confirm('Delete this order?')) { await fetch(`https://moes-jerky-backend3.onrender.com/orders/${id}`, { method: 'DELETE' }); renderOrders(); }}
    function exportOrders() { let csv='Name,Email,Phone,Address,Items,Amount,Status\n'; orders.forEach(o=>{ const c=o.customer; csv+=`"${c.name}","${c.email}","${c.phone}","${c.address}","${o.cart.map(i=>i.name+' x'+i.quantity).join(' | ')}","$${o.amount.toFixed(2)}","${o.status}"\n`; }); const b=new Blob([csv],{type:'text/csv'}), u=URL.createObjectURL(b), a=document.createElement('a'); a.href=u; a.download='orders.csv'; a.click(); }
    // Products
    async function renderProducts() { const res = await fetch('https://moes-jerky-backend3.onrender.com/items'); items = await res.json(); const tbl = document.getElementById('productsTable'); tbl.innerHTML = '<tr><th>Name</th><th>Price</th><th>Actions</th></tr>'; items.forEach((it,i) => { tbl.innerHTML += `<tr><td><input class="product-input" value="${it.name}" onchange="items[${i}].name=this.value"/></td><td><input type="number" class="product-input" value="${it.price}" onchange="items[${i}].price=parseFloat(this.value)"/></td><td><button onclick="deleteProduct(${i})">Delete</button></td></tr>`; }); }
    async function addProduct() {
  items.push({ name: '', price: 0 });
  await saveProducts(); // Persist new item
  renderProducts(); // Re-render with updated list
}
    async function deleteProduct(i) { items.splice(i,1); renderProducts(); }
    async function saveProducts() {
  const btn = document.querySelector('#productsTab .save-btn');
  const origText = btn.innerText;
  btn.disabled = true;
  btn.innerText = 'Processing...';
  // Remove any previous message
  let msg = document.getElementById('products-save-msg');
  if (msg) msg.remove();
  try {
    await fetch('https://moes-jerky-backend3.onrender.com/items', {
      method: 'POST',
      headers: { 'Content-Type':'application/json' },
      body: JSON.stringify(items)
    });
    renderProducts();
    // Show success message
    msg = document.createElement('span');
    msg.id = 'products-save-msg';
    msg.innerText = 'Saved!';
    msg.style.marginLeft = '12px';
    msg.style.color = '#0a8a0a';
    msg.style.fontWeight = 'bold';
    btn.parentNode.insertBefore(msg, btn.nextSibling);
    setTimeout(() => { if (msg) msg.remove(); }, 2000);
  } finally {
    btn.disabled = false;
    btn.innerText = origText;
  }
}
    // Users
    async function renderUsers() {
  const res = await fetch('https://moes-jerky-backend3.onrender.com/users');
  users = await res.json();
  const tbl = document.getElementById('usersTable');
  tbl.innerHTML = '<tr><th>Name</th><th>Code</th><th>Actions</th></tr>';
  users.forEach((u,i)=>{
    tbl.innerHTML += `<tr><td><input class="user-input" value="${u.name}" onchange="users[${i}].name=this.value"/></td><td><input type="password" class="user-input" value="${u.code}" onchange="users[${i}].code=this.value"/></td><td><button onclick="deleteUser(${i})">Delete</button></td></tr>`;
  });
}
// Show add user form
function showAddUserForm() {
  document.getElementById('addUserForm').style.display = 'block';
  document.getElementById('showAddUserBtn').style.display = 'none';
  document.getElementById('newUserName').value = '';
  document.getElementById('newUserCode').value = '';
  setTimeout(()=>document.getElementById('newUserName').focus(), 100);
}
    async function addUser() { const n=document.getElementById('newUserName').value, c=document.getElementById('newUserCode').value; if(n&&c.length===6&&!isNaN(c)){ users.push({name:n,code:c}); renderUsers(); document.getElementById('newUserName').value=''; document.getElementById('newUserCode').value=''; saveUsers(); } else alert('Enter valid 6-digit code'); }
    async function deleteUser(i) { if(confirm('Delete this user?')){ users.splice(i,1); renderUsers(); saveUsers(); }}
    async function saveUsers() { await fetch('https://moes-jerky-backend3.onrender.com/users/bulk',{ method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify(users) }); renderUsers(); }
    // Analytics
    async function renderAnalytics() { const res = await fetch('https://moes-jerky-backend3.onrender.com/orders'); orders = await res.json(); const total = orders.reduce((s,o)=>s+o.amount,0), count = orders.length, avg = count?total/count:0; document.getElementById('totalSales').innerText=`$${total.toFixed(2)}`; document.getElementById('orderCount').innerText=count; document.getElementById('avgOrder').innerText=`$${avg.toFixed(2)}`; const prodCount = {}, tp = document.getElementById('topProducts'); tp.innerHTML=''; orders.forEach(o=>o.cart.forEach(i=>prodCount[i.name]=(prodCount[i.name]||0)+i.quantity)); Object.entries(prodCount).sort((a,b)=>b[1]-a[1]).slice(0,5).forEach(([nm,q])=>{ const li=document.createElement('li'); li.innerText=`${nm}: ${q}`; tp.appendChild(li); }); const cm = {}, cs = document.getElementById('customerStats'); cs.innerHTML=''; orders.forEach(o=>{ cm[o.customer.name]=(cm[o.customer.name]||0)+o.amount }); Object.entries(cm).forEach(([nm,val])=>{ const li=document.createElement('li'); li.innerText=`${nm}: $${val.toFixed(2)}`; cs.appendChild(li); }); }
  function showSaveButton(orderId) {
  document.getElementById('save-status-' + orderId).style.display = 'inline-block';
}
function saveOrderStatus(orderId) {
  const select = document.getElementById('status-select-' + orderId);
  const newStatus = select.value;
  updateOrderStatus(orderId, newStatus);
  document.getElementById('save-status-' + orderId).style.display = 'none';
}
</script>
</body>
</html>
